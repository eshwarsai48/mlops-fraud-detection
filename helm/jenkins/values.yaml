jenkins:
  controller:
    image:
      repository: jenkins/jenkins
      tag: lts

    serviceType: LoadBalancer
    servicePort: 8080
    targetPort: 8080
    loadBalancerIP: "52.234.153.72"
    serviceAnnotations:
      service.beta.kubernetes.io/azure-load-balancer-resource-group: mlops-dev-rg
      service.beta.kubernetes.io/azure-load-balancer-ipv4: 52.234.153.72
      service.beta.kubernetes.io/azure-load-balancer-internal: "false"

    jenkinsUrl: "http://52.234.153.72:8080"

    envFromSecret: jenkins-credentials
    env:
      - name: KUBECONFIG
        value: /var/run/secrets/kubeconfig/kubeconfig

    additionalVolumes:
      - name: kubeconfig
        secret:
          secretName: jenkins-kubeconfig
    additionalVolumeMounts:
      - name: kubeconfig
        mountPath: /var/run/secrets/kubeconfig
        readOnly: true

    initContainers:
      - name: install-kubectl
        image: bitnami/kubectl:latest
        command: ["sh", "-c", "cp /usr/bin/kubectl /tools/kubectl"]
        volumeMounts:
          - mountPath: /tools
            name: tools

    extraVolumes:
      - name: tools
        emptyDir: {}
    extraVolumeMounts:
      - name: tools
        mountPath: /usr/local/bin

    installPlugins:
      - kubernetes:latest
      - configuration-as-code:latest
      - workflow-job:latest
      - credentials:latest
      - git:latest

    # ðŸ‘‡ Correct place for overrides on Helm 5.8+
    JCasC:
      defaultConfig: false
      overrides:
        configScripts:

          secrets.yaml: |
            unclassified:
              secretSources:
                - environment: {}

          credentials.yaml: |
            credentials:
              system:
                domainCredentials:
                  - credentials:
                      - usernamePassword:
                          scope: GLOBAL
                          id: "acr-credentials"
                          username: "${ACR_USERNAME}"
                          password: "${ACR_PASSWORD}"
                          description: "Azure ACR credentials"
                      - string:
                          scope: GLOBAL
                          id: "github-pat"
                          secret: "${GITHUB_TOKEN}"
                          description: "GitHub PAT"

          jenkins.yaml: |
            jenkins:
              systemMessage: "Jenkins configured via Helm (JCasC.overrides)"
              numExecutors: 2
              clouds:
                - kubernetes:
                    name: "kubernetes"
                    serverUrl: "https://kubernetes.default.svc.cluster.local"
                    namespace: "jenkins"
                    jenkinsUrl: "http://jenkins:8080"
                    containerCapStr: "10"
                    templates:
                      - name: "kaniko"
                        label: "kaniko"
                        serviceAccount: "default"
                        containers:
                          - name: "kaniko"
                            image: "gcr.io/kaniko-project/executor:latest"
                            command: ["cat"]
                            ttyEnabled: true
                            volumeMounts:
                              - mountPath: "/kaniko/.docker"
                                name: "acr-config"
                        volumes:
                          - secretVolume:
                              mountPath: "/kaniko/.docker"
                              secretName: "acr-basic-auth"

    sidecars:
      configAutoReload:
        enabled: true

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

    admin:
      username: admin

persistence:
  enabled: true
  size: 10Gi
  storageClass: default
